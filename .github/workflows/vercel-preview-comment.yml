name: Vercel Preview URL Comment

on:
  deployment_status:

jobs:
  preview-url:
    if: github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success' && contains(github.event.deployment_status.environment, 'Preview')
    runs-on: ubuntu-latest
    steps:
      - name: Debug deployment event
        env:
          EVENT_JSON: ${{ toJSON(github.event) }}
        run: |
          echo "Deployment Event:"
          echo "$EVENT_JSON"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const { deployment_status, deployment } = context.payload;
            
            // Get PR number from deployment metadata
            const prNumber = deployment.payload.pr_id;
            
            if (!prNumber) {
              console.log('No PR number found in deployment payload');
              return;
            }
            
            // Create comment content
            const commentBody = `
            📝 Preview deployment for this PR is ready!
            
            🔍 Preview URL: ${deployment_status.target_url}
            
            ⚡ Deployed by Vercel
            `;
            
            // Add comment to PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });